#!/usr/bin/env node

/**
 * Codex Father CLI 主入口点
 * 可执行的 CLI 入口脚本，提供统一的命令行接口
 */

// 检查 Node.js 版本要求
const MIN_NODE_VERSION = 18;
const currentVersion = process.versions.node;
const majorVersion = parseInt(currentVersion.split('.')[0], 10);

if (majorVersion < MIN_NODE_VERSION) {
  console.error(`❌ Error: Node.js ${MIN_NODE_VERSION}+ is required. Current version: ${currentVersion}`);
  console.error('Please upgrade Node.js: https://nodejs.org/');
  process.exit(1);
}

// 错误边界：捕获未处理的异常
process.on('uncaughtException', (error) => {
  console.error('❌ Uncaught Exception:', error.message);
  console.error('Stack trace:', error.stack);
  process.exit(1);
});

process.on('unhandledRejection', (reason, promise) => {
  console.error('❌ Unhandled Rejection at:', promise, 'reason:', reason);
  process.exit(1);
});

// 动态导入并启动 CLI 应用
async function main() {
  try {
    // 根据环境选择入口文件和加载方式
    const isProduction = process.env.NODE_ENV === 'production';

    let startFn;

    if (isProduction) {
      // 生产环境：尝试导入构建的 JavaScript 文件
      try {
        const module = await import('../dist/core/cli/start.js');
        startFn = module.default ?? module.startCLI;
      } catch (importError) {
        console.error('❌ Production build not found. Please run: npm run build');
        throw new Error('Production build is required in production mode');
      }
    } else {
      // 开发与测试环境：在当前进程内通过 tsx 注册器加载 TypeScript 源码
      const { register } = await import('tsx/esm/api');
      const unregister = register();
      const module = await import('../core/cli/start.ts');
      startFn = module.default ?? module.startCLI;
      const cleanup = async () => {
        if (typeof unregister === 'function') {
          await unregister();
        } else if (typeof unregister?.unregister === 'function') {
          await unregister.unregister();
        }
      };
      return await runAndCleanup(startFn, cleanup);
    }

    if (typeof startFn === 'function') {
      await startFn();
    } else {
      throw new Error('No valid CLI entry point found in the imported module');
    }
  } catch (error) {
    console.error('❌ Failed to start Codex Father CLI:');
    console.error(`   ${error.message}`);

    // 提供有用的调试信息
    if (error.code === 'MODULE_NOT_FOUND') {
      console.error('\n💡 Suggestions:');
      console.error('   1. Run `npm install` to install dependencies');
      console.error('   2. Run `npm run build` to build the project');
      console.error('   3. Check that all required files exist');
    }

    // 在开发环境显示完整堆栈
    if (process.env.NODE_ENV === 'development' || process.env.DEBUG) {
      console.error('\n🔍 Debug information:');
      console.error(error.stack);
    }

    process.exit(1);
  }
}

async function runAndCleanup(execute, cleanup) {
  try {
    if (typeof execute === 'function') {
      await execute();
    }
  } finally {
    if (typeof cleanup === 'function') {
      await cleanup();
    }
  }
}

// 启动应用
main().catch((error) => {
  console.error('❌ Fatal error during CLI startup:', error.message);
  process.exit(1);
});
