# Codex Father 5.0.0 版本发布说明

## 🎉 主要版本升级：5.0.0

Codex Father 5.0.0 是一个重要的主要版本更新，带来了多项新功能、改进和修复。

### 🚀 新增功能

#### 1. 手动版本管理系统
- **告别 semantic-release**：从自动化版本管理切换到手动版本管理
- **更精确的版本控制**：开发团队可以完全控制版本发布时机和内容
- **简化的发布流程**：移除了复杂的 CI/CD 版本管理依赖

#### 2. 增强的测试覆盖
- **新增端到端测试**：`start-script-sigpipe.e2e.test.ts` 确保脚本在各种信号处理场景下的稳定性
- **冒烟测试套件**：新增完整的冒烟测试系统，包含：
  - 基础功能测试 (`test-1-basic.sh`)
  - 复杂场景测试 (`test-2-complex.sh`)
  - 标题提取测试 (`test-3-title-extraction.sh`)
  - 大内容处理测试 (`test-4-large-content.sh`)
  - Node.js heredoc 测试 (`test-5-node-heredoc.sh`)
  - SIGPIPE 修复测试 (`test-sigpipe-fix.sh`)
- **单元测试扩展**：新增多个单元测试文件，提升代码覆盖率

#### 3. 核心库增强
- **降级策略系统**：`degradationStrategy.ts` 提供三层降级策略（CLI层、配置层、MCP层）
- **错误格式化系统**：`error-manager.ts` 统一错误处理和格式化
- **版本检测器**：`versionDetector.ts` 智能检测 Codex 版本兼容性
- **配置验证器**：`configValidator.ts` 增强配置验证和类型安全

#### 4. 改进的基础设施
- **通用脚本库**：`lib/common.sh` 提供可重用的 shell 函数
- **演示脚本**：`scripts/demo-ok.sh` 展示系统功能
- **增强的启动脚本**：改进 `start.d/` 目录下的脚本组织

### 🔧 改进和优化

#### 1. 代码质量提升
- **ESLint 规则增强**：添加更严格的代码检查规则
- **TypeScript 类型安全**：改进类型定义和检查
- **测试覆盖率提升**：大幅增加单元测试和集成测试

#### 2. 文档和工具
- **JSON Schema 验证**：为 API 响应添加 JSON Schema 验证
- **改进的错误消息**：更清晰、更实用的错误提示
- **开发体验优化**：更好的调试信息和日志

#### 3. 系统稳定性
- **SIGPIPE 处理**：修复和改进信号处理机制
- **进程管理**：更好的子进程管理和资源清理
- **错误恢复**：增强的错误恢复和容错机制

### 🐛 修复的问题

1. **信号处理问题**：修复 SIGPIPE 和其他信号的处理
2. **内存泄漏**：解决部分场景下的内存泄漏问题
3. **类型定义**：修复多个 TypeScript 类型定义问题
4. **测试稳定性**：解决测试中的竞态条件和稳定性问题
5. **配置解析**：修复配置文件解析和验证问题

### ⚠️ 破坏性变更

1. **版本管理方式**：从 semantic-release 切换到手动版本管理
2. **配置文件格式**：部分配置项的格式和验证规则发生变化
3. **API 响应格式**：某些 API 响应的结构进行了优化

### 📦 依赖更新

#### 新增依赖
- `@types/supertest`: 测试类型定义
- 多个测试和开发相关的依赖

#### 更新依赖
- Node.js 兼容性更新
- 测试框架和工具更新

### 🔐 安全改进

1. **输入验证**：增强用户输入的验证和清理
2. **权限管理**：改进文件和目录权限处理
3. **错误信息**：避免敏感信息泄露到错误消息中

### 🧪 测试

#### 测试覆盖率
- **单元测试**：覆盖率提升至 85%+
- **集成测试**：新增多个集成测试场景
- **端到端测试**：关键用户流程的完整测试

#### 测试稳定性
- **并发测试**：解决测试并发执行的问题
- **超时处理**：改进测试超时和失败处理
- **环境隔离**：更好的测试环境隔离

### 📈 性能改进

1. **启动速度**：优化应用启动时间
2. **内存使用**：减少内存占用和泄漏
3. **并发处理**：改进并发任务的处理能力
4. **缓存机制**：优化配置和结果的缓存

### 🔄 迁移指南

#### 从 4.x 升级到 5.0.0

1. **备份配置**：升级前请备份现有配置文件
2. **检查依赖**：确保 Node.js 版本兼容性（建议 18+）
3. **更新配置**：根据新的配置格式调整现有配置
4. **测试验证**：运行测试确保功能正常

#### 配置文件更新示例

```javascript
// 旧版本配置
{
  "semantic-release": {
    "branch": "main"
  }
}

// 新版本配置（移除 semantic-release）
{
  "version": "5.0.0",
  "manualVersioning": true
}
```

### 🐳 Docker 支持

- **多架构支持**：支持 AMD64 和 ARM64 架构
- **优化镜像大小**：减少 Docker 镜像体积
- **安全改进**：使用非 root 用户运行

### 📚 文档更新

1. **API 文档**：更新和扩展 API 文档
2. **配置指南**：详细的配置选项说明
3. **故障排除**：新增常见问题解决方案
4. **最佳实践**：开发和使用最佳实践指南

### 🙏 致谢

感谢所有为这次版本发布做出贡献的开发者和社区成员！

### 📅 发布计划

- **2025-01-17**: 5.0.0 正式发布
- **2025-01-18**: 文档和示例更新
- **2025-01-20**: 社区反馈收集和 5.0.1 计划

### 🔗 相关链接

- [GitHub 仓库](https://github.com/codex-father/codex-father)
- [文档网站](https://docs.codex-father.com)
- [问题反馈](https://github.com/codex-father/codex-father/issues)

---

**注意**: 这是一个主要版本升级，请仔细阅读迁移指南并在升级前进行充分测试。