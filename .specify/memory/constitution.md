<!--
同步影响报告 (Sync Impact Report)
- 版本变更：1.0.0 → 1.1.0
- 修改的原则：无（扩展）
- 新增部分：
  * 新增第六原则：协议与架构决策（MCP 协议优先、异步响应机制、进程管理策略）
  * 扩展了测试优先开发：增加 MCP 协议测试和 Codex JSON-RPC 方法测试要求
- 移除部分：无
- 模板更新状态：
  * ✅ 已更新：.specify/templates/plan-template.md（Constitution Check 部分需反映新原则）
  * ⏳ 待更新：specs/005-docs-prd-draft/plan.md（正在更新中）
- 后续 TODO：更新现有模板中的 Constitution Check 部分以包含第六原则
-->

# Codex Father 项目宪章

## 核心原则

### 一、代码质量与可维护性

**必须遵循的规则**：

- 代码必须清晰、可读、易于维护，优先考虑代码可读性而非炫技
- 严格遵循 DRY（Don't Repeat
  Yourself）原则：识别并消除重复代码，通过抽象和复用提升维护性
- 严格遵循 KISS（Keep It Simple, Stupid）原则：追求简洁设计，拒绝不必要的复杂性
- 严格遵循 YAGNI（You Aren't Gonna Need
  It）原则：仅实现当前明确需要的功能，避免过度设计
- 统一的代码风格：Shell 脚本遵循 Google Shell Style
  Guide，TypeScript 遵循项目 ESLint 配置
- 函数和变量命名必须具有描述性：Shell 使用 `snake_case`，TypeScript 使用
  `camelCase`
- 关键逻辑必须添加注释说明意图和复杂决策的原因

**理由**：高质量代码是项目长期可持续发展的基石。Codex
Father 作为工具集，需要被多人维护和扩展，清晰的代码结构能显著降低协作成本和错误率。

### 二、测试优先开发（TDD - 非协商项）

**必须遵循的规则**：

- 所有新功能必须采用测试驱动开发（TDD）流程：编写测试 → 用户审批 → 测试失败 → 实现代码 → 测试通过
- Red-Green-Refactor 循环严格执行：先红（测试失败）→ 再绿（测试通过）→ 后重构
- 核心功能测试覆盖率必须 ≥80%，关键路径覆盖率必须 100%
- 测试金字塔：单元测试（基础） → 集成测试（重点） → 端到端测试（关键场景）
- 测试必须独立、可重复、快速执行（单元测试 <100ms，集成测试 <5s）
- 契约测试（Contract Tests）必须覆盖所有 MCP 工具接口和 CLI 命令

**理由**：Codex
Father 涉及复杂的指令组合、异步任务管理和 MCP 协议交互，测试是保证系统可靠性的唯一手段。TDD 确保代码从设计之初就是可测试的，避免后补测试的困境。

### 三、用户体验一致性

**必须遵循的规则**：

- CLI 命令必须遵循统一的参数命名和行为模式（如 `--task`、`--dry-run`、`--json`
  等）
- 所有命令必须支持 `--help` 参数，提供清晰的使用说明和示例
- 错误消息必须明确、具体、可操作：说明错误原因、影响范围、建议解决方案
- 输出格式必须统一：支持人类可读（默认）和机器可解析（`--json`）两种模式
- 交互式操作必须提供清晰的进度反馈（如任务状态、日志尾随）
- 文档必须完整：每个功能都有对应的使用文档和示例
- 默认行为必须安全且符合直觉，高危操作必须明确标注并需要确认

**理由**：用户体验的一致性直接影响工具的采用率和满意度。统一的交互模式降低学习成本，清晰的错误处理减少用户挫败感，完整的文档提升工具的专业性。

### 四、性能与效率要求

**必须遵循的性能指标**：

- CLI 命令启动时间 < 1 秒（不含 Codex 执行时间）
- MCP 工具调用响应时间 < 500 毫秒（同步工具）
- 异步任务启动延迟 < 2 秒
- 指令组合与预处理时间 < 3 秒（即使处理大量文件）
- 内存占用：Shell 脚本 < 100MB，MCP 服务器 < 200MB（空闲时）
- 并发任务管理：支持至少 10 个并发异步任务而不显著降低性能

**必须遵循的优化原则**：

- 避免不必要的文件 I/O 和进程创建
- 使用增量处理和缓存机制（如会话日志、元数据缓存）
- 异步操作优先，避免阻塞用户交互
- 对大文件和大量文件的处理必须优化（流式处理、分批处理）
- 性能关键路径必须有性能测试和基准（benchmark）

**理由**：作为开发工具，性能直接影响开发者的工作效率。慢速的工具会打断开发流程，降低生产力。性能要求也是对代码质量的约束，促使开发者编写高效的代码。

### 五、安全与可靠性

**必须遵循的安全规则**：

- 默认安全策略：未明确授权时，使用 `--sandbox workspace-write` 限制操作范围
- 输入验证：所有用户输入必须经过验证和清理，防止注入攻击
- 敏感信息脱敏：支持 `--redact` 和 `--redact-pattern`，日志中不得泄露敏感数据
- 审计日志：所有执行的命令、参数、结果必须记录在会话日志中
- 错误恢复：异常情况必须有明确的错误处理和恢复机制，避免脏数据和不一致状态
- 依赖安全：定期更新依赖，修复已知安全漏洞

**必须遵循的可靠性规则**：

- 幂等性：重复执行相同操作应产生相同结果（对于查询类操作）
- 原子性：关键操作要么完全成功，要么完全失败（如任务创建、状态更新）
- 状态持久化：异步任务状态必须可靠持久化到磁盘，支持崩溃恢复
- 优雅降级：依赖服务不可用时，提供清晰的错误提示而非崩溃
- 超时控制：所有外部调用必须设置合理的超时时间

**理由**：安全漏洞和可靠性问题会导致用户数据丢失、隐私泄露或工作流中断。作为执行代码的工具，Codex
Father 必须最高优先级保障安全和可靠性。

### 六、协议与架构决策

**必须遵循的协议原则**：

- **MCP 协议优先**：对外接口统一使用 MCP（Model Context
  Protocol）作为主协议，确保与外部生态系统（IDE、AI 工具链）的最佳兼容性
- **协议桥接层**：标准 MCP 协议与后端引擎（Codex 等）的自定义协议之间必须有明确的桥接层，负责协议转换和事件映射
- **异步响应机制**：所有可能长时间运行的操作必须采用异步响应模式：
  - 快速返回轻量结果（如 `{ status: "accepted", jobId, conversationId }`）
  - 通过 MCP `notifications` 推送实际执行进度
  - 使用唯一 ID（`jobId`）关联请求和后续事件
- **事件驱动设计**：系统内部通信优先采用事件驱动模式，支持松耦合和可扩展性
- **协议版本管理**：MCP 协议版本和 Codex
  JSON-RPC 版本必须明确记录，兼容性破坏必须有迁移计划

**必须遵循的架构原则**：

- **进程管理策略**：
  - MVP1：单进程管理，排队执行（前端不阻塞，后端串行）
  - MVP2：进程池管理，真正并行（多进程独立运行）
  - 进程崩溃必须有自动重启和会话恢复机制（基于外部持久化文件）
- **会话恢复依赖**：会话恢复必须基于后端引擎的原生持久化文件（如 Codex 的 rollout 文件），不得依赖自定义日志格式
- **扩展性设计**：架构必须支持接入多种 agent 类型（Codex、Claude
  Code 等），通过配置文件定义 agent 启动命令、通信协议、事件解析规则
- **关注点分离**：
  - 协议层（MCP）：负责外部通信
  - 桥接层：负责协议转换和事件映射
  - 管理层：负责进程管理、会话调度、审批策略
  - 持久化层：负责日志记录、状态保存（仅用于监控和审计，不用于恢复）
- **配置驱动**：系统行为（审批策略、超时时间、进程数量、agent 定义等）必须通过配置文件控制，避免硬编码

**必须遵循的测试原则（扩展）**：

- **协议契约测试**：所有 MCP 标准方法（`initialize`、`tools/list`、`tools/call`、`notifications`）必须有契约测试
- **桥接层测试**：协议转换逻辑（MCP ↔ Codex
  JSON-RPC）必须有完整的单元测试和集成测试
- **异步响应测试**：必须验证快速返回 + 事件通知的完整流程，包括 `jobId` 关联
- **进程管理测试**：进程启动、监控、崩溃恢复、会话恢复必须有集成测试
- **审批机制测试**：策略引擎、人工审批兜底、超时处理必须有完整测试覆盖

**理由**：Codex
Father 的核心价值在于提供稳定、可扩展的 MCP 协议支持和多 agent 管理能力。统一的协议原则和清晰的架构分层确保系统能够与外部生态无缝集成，同时保持内部的灵活性和可维护性。异步响应机制是避免客户端阻塞的关键，进程管理策略决定了系统的并发能力和可靠性。

## 开发流程与协作规范

### 代码审查（Code Review）

- 所有代码变更必须通过 Pull Request 提交，不得直接推送到主分支
- PR 必须至少有一位审查者批准后才能合并
- 审查重点：代码质量、测试覆盖、性能影响、安全风险、文档完整性
- 审查者必须验证测试通过且符合宪章要求

### Pull Request 要求

- PR 标题必须清晰描述变更内容，遵循 Conventional Commits 规范（如 `feat:`,
  `fix:`, `docs:`, `test:`）
- PR 描述必须包含：变更动机、实现方案、测试策略、性能影响评估
- 每个 PR 必须附带：代码变更 + 测试代码 + 文档更新（如适用）
- 大型变更必须分解为多个小型 PR，逐步合并

### 持续集成（CI）

- 所有 PR 必须通过 CI 检查才能合并：单元测试、集成测试、端到端测试、代码风格检查
- CI 流程必须包含性能基准测试，防止性能回退
- CI 失败的 PR 不得合并，除非失败原因明确且与变更无关

### 分支策略

- 主分支（`main`）：稳定版本，始终可发布
- 特性分支（`feature/*`）：新功能开发
- 修复分支（`fix/*`）：Bug 修复
- 发布分支（`release/*`）：版本发布准备

## 质量门禁

### 性能基准（Performance Benchmarks）

- 每次发布前必须运行性能基准测试，确保满足第四原则的性能指标
- 性能回退（>10%）必须有明确的理由和权衡分析
- 性能关键路径的变更必须附带性能测试报告

### 安全检查（Security Audit）

- 依赖安全扫描：使用 `npm audit`（TypeScript）和 `shellcheck`（Shell 脚本）
- 代码安全审查：敏感操作（文件操作、进程创建、网络调用）必须重点审查
- 发布前必须确认没有已知的高危或严重安全漏洞

### 文档完整性（Documentation Completeness）

- 新功能必须有对应的使用文档和示例
- API 变更必须更新相关文档和 CHANGELOG
- 复杂逻辑必须有架构文档或设计文档
- README 和主要文档必须保持最新

### 测试覆盖率门禁

- 核心功能测试覆盖率 ≥80%
- 新增代码测试覆盖率 ≥90%
- 关键路径测试覆盖率 100%
- PR 不得降低整体测试覆盖率（除非有合理的例外情况）

## 治理

### 宪章权威性

本宪章是 Codex
Father 项目的最高指导原则，优先级高于其他所有实践、约定和个人偏好。

### 修订程序

- 宪章修订必须提交 PR，经过团队讨论和投票（多数同意）
- 修订 PR 必须包含：修订理由、影响分析、迁移计划（如适用）
- 修订后版本号根据语义化版本规则递增：
  - **主版本（MAJOR）**：移除或重新定义核心原则，不向后兼容
  - **次版本（MINOR）**：新增原则或显著扩展指导内容
  - **修订版（PATCH）**：澄清措辞、修正错误、非语义性改进

### 合规性审查

- 所有 PR 必须验证是否符合宪章要求
- 复杂性和特殊情况必须在 PR 中明确说明和论证
- 代码审查者有责任确保宪章合规性

### 运行时开发指导

开发过程中如有疑问或需要详细指导，请参考：

- 代码风格：`.editorconfig`、`eslint.config.js`（TypeScript）、Google Shell
  Style Guide（Shell）
- 测试指南：`tests/README.md`（如存在）
- 贡献指南：`AGENTS.md`
- 架构文档：``

---

**版本**: 1.1.0 | **批准日期**: 2025-09-27 | **最后修订**: 2025-09-30

### 版本历史

- **1.1.0**
  (2025-09-30): 新增第六原则"协议与架构决策"，明确 MCP 协议优先、异步响应机制、进程管理策略等架构决策；扩展测试原则以包含协议契约测试和桥接层测试
- **1.0.0** (2025-09-27): 初始版本，确立五项核心原则和开发流程规范
