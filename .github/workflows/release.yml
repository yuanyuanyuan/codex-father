name: Release

on:
  push:
    branches: [main]
  workflow_dispatch: {}

permissions:
  contents: write

jobs:
  release:
    concurrency:
      group: release-${{ github.ref }}
      cancel-in-progress: true
    runs-on: ubuntu-latest
    env:
      NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org/'

      - name: Configure npm for npmjs
        run: |
          if [ -n "${NPM_TOKEN:-}" ]; then
            echo "//registry.npmjs.org/:_authToken=${NPM_TOKEN}" >> "$NPM_CONFIG_USERCONFIG"
            echo "always-auth=true" >> "$NPM_CONFIG_USERCONFIG"
          else
            echo "NPM_TOKEN not set; npm publish will be skipped by semantic-release."
          fi
        env:
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Install dependencies (mcp package)
        working-directory: mcp/codex-mcp-server
        run: npm ci --legacy-peer-deps

      - name: Build (mcp package)
        working-directory: mcp/codex-mcp-server
        run: npm run build

      - name: Install semantic-release + plugins (no-save)
        run: |
          npm i --no-save \
            semantic-release \
            @semantic-release/commit-analyzer \
            @semantic-release/release-notes-generator \
            @semantic-release/changelog \
            @semantic-release/exec \
            @semantic-release/git \
            @semantic-release/github

      - name: Changelog gate (dry-run)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # 默认严格：不允许从 [Unreleased] 回退生成
          # ALLOW_UNRELEASED_FALLBACK 未设置时，generateNotes 将在缺失版本条目时失败
        run: npx semantic-release --dry-run

      - name: Debug npm identity
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: npm whoami || true

      - name: Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: npx semantic-release
