# codex-father 2.0 æ— äº¤äº’æ‰§è¡Œæ¨¡å¼ PRD

## æ–‡æ¡£ä¿¡æ¯

| é¡¹ç›®         | å†…å®¹                                        |
| ------------ | ------------------------------------------- |
| **æ–‡æ¡£æ ‡é¢˜** | codex-father 2.0 Headless Mode äº§å“éœ€æ±‚æ–‡æ¡£ |
| **æ–‡æ¡£ç‰ˆæœ¬** | v1.0.0                                      |
| **åˆ›å»ºæ—¥æœŸ** | 2025-10-01                                  |
| **ä½œè€…**     | å¹½æµ®å–µ (AI Assistant)                       |
| **é€‚ç”¨äº§å“** | codex-father 2.0                            |
| **æ–‡æ¡£çŠ¶æ€** | âœ… å·²å®Œæˆ                                   |

---

## ğŸ“‹ ç›®å½•

1. [äº§å“æ¦‚è¿°](#äº§å“æ¦‚è¿°)
2. [æ ¸å¿ƒåŠŸèƒ½](#æ ¸å¿ƒåŠŸèƒ½)
3. [æŠ€æœ¯è§„èŒƒ](#æŠ€æœ¯è§„èŒƒ)
4. [ä½¿ç”¨åœºæ™¯](#ä½¿ç”¨åœºæ™¯)
5. [é…ç½®æŒ‡å—](#é…ç½®æŒ‡å—)
6. [é›†æˆæ–¹æ¡ˆ](#é›†æˆæ–¹æ¡ˆ)
7. [å®‰å…¨è§„èŒƒ](#å®‰å…¨è§„èŒƒ)
8. [æœ€ä½³å®è·µ](#æœ€ä½³å®è·µ)
9. [æ•…éšœæ’æŸ¥](#æ•…éšœæ’æŸ¥)
10. [é™„å½•](#é™„å½•)

---

## 1. äº§å“æ¦‚è¿°

### 1.1 èƒŒæ™¯

codex-father 2.0 å¼•å…¥äº† **Headless Modeï¼ˆæ— å¤´æ¨¡å¼ï¼‰** å’Œ
**è‡ªä¸»æ‰§è¡Œèƒ½åŠ›**ï¼Œä½¿å¼€å‘è€…èƒ½å¤Ÿåœ¨ CI/CD æµæ°´çº¿ã€è‡ªåŠ¨åŒ–è„šæœ¬å’Œæ‰¹å¤„ç†ä»»åŠ¡ä¸­æ— äº¤äº’åœ°è¿è¡Œ Claude
Codeï¼Œå®ç°çœŸæ­£çš„ç¼–ç¨‹è‡ªåŠ¨åŒ–ã€‚

### 1.2 ç›®æ ‡ç”¨æˆ·

- **DevOps å·¥ç¨‹å¸ˆ**: é›†æˆåˆ° CI/CD æµæ°´çº¿
- **å¼€å‘å›¢é˜Ÿ**: è‡ªåŠ¨åŒ–ä»£ç å®¡æŸ¥ã€æµ‹è¯•ä¿®å¤
- **SRE å›¢é˜Ÿ**: äº‹ä»¶å“åº”è‡ªåŠ¨åŒ–
- **å®‰å…¨å›¢é˜Ÿ**: è‡ªåŠ¨åŒ–å®‰å…¨å®¡è®¡

### 1.3 æ ¸å¿ƒä»·å€¼

âœ… **è‡ªåŠ¨åŒ–**: æ— éœ€äººå·¥å¹²é¢„å®Œæˆå¤æ‚ç¼–ç¨‹ä»»åŠ¡ âœ…
**å¯ç¼–ç¨‹**: æ”¯æŒè„šæœ¬è°ƒç”¨å’Œæµç¨‹ç¼–æ’ âœ… **å®‰å…¨å¯æ§**: å·¥å…·ç™½åå•å’Œæƒé™ç®¡ç† âœ…
**å¯è§‚æµ‹**: ç»“æ„åŒ–è¾“å‡ºå’Œæ—¥å¿—è®°å½•

---

## 2. æ ¸å¿ƒåŠŸèƒ½

### 2.1 åŠŸèƒ½æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          codex-father 2.0 æ ¸å¿ƒ           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Headless     â”‚  â”‚  YOLO Mode      â”‚ â”‚
â”‚  â”‚ Mode         â”‚  â”‚  (å®Œå…¨è‡ªä¸»)      â”‚ â”‚
â”‚  â”‚ (æ¨è)       â”‚  â”‚                 â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚      å·¥å…·æƒé™ç®¡ç†ç³»ç»Ÿ             â”‚  â”‚
â”‚  â”‚  - AllowedTools ç™½åå•            â”‚  â”‚
â”‚  â”‚  - DisallowedTools é»‘åå•         â”‚  â”‚
â”‚  â”‚  - Permission Mode é…ç½®           â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚      è¾“å‡ºæ ¼å¼ç³»ç»Ÿ                 â”‚  â”‚
â”‚  â”‚  - Text (çº¯æ–‡æœ¬)                  â”‚  â”‚
â”‚  â”‚  - JSON (ç»“æ„åŒ–)                  â”‚  â”‚
â”‚  â”‚  - Stream-JSON (æµå¼)             â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 åŠŸèƒ½ç‰¹æ€§å¯¹æ¯”

| ç‰¹æ€§         | Interactive Mode | Headless Mode   | YOLO Mode          |
| ------------ | ---------------- | --------------- | ------------------ |
| **ç”¨æˆ·äº¤äº’** | âœ… éœ€è¦          | âŒ ä¸éœ€è¦       | âŒ ä¸éœ€è¦          |
| **æƒé™ç¡®è®¤** | âœ… æ¯æ¬¡ç¡®è®¤      | ğŸ”„ å¯é…ç½®       | âŒ å®Œå…¨è·³è¿‡        |
| **å·¥å…·é™åˆ¶** | âŒ æ— é™åˆ¶        | âœ… å¯é…ç½®ç™½åå• | âœ… å¿…é¡»é…ç½®        |
| **è¾“å‡ºæ ¼å¼** | ç»ˆç«¯å‹å¥½         | å¯ç¼–ç¨‹          | å¯ç¼–ç¨‹             |
| **é€‚ç”¨åœºæ™¯** | å¼€å‘è°ƒè¯•         | CI/CD è‡ªåŠ¨åŒ–    | å—æ§ç¯å¢ƒæ‰¹å¤„ç†     |
| **å®‰å…¨ç­‰çº§** | ğŸŸ¢ é«˜            | ğŸŸ¡ ä¸­           | ğŸ”´ ä½ (éœ€ä¸¥æ ¼é…ç½®) |

---

## 3. æŠ€æœ¯è§„èŒƒ

### 3.1 å‘½ä»¤è¡Œæ¥å£

#### åŸºç¡€è¯­æ³•

```bash
claude -p "PROMPT" [OPTIONS]
```

#### æ ¸å¿ƒå‚æ•°

| å‚æ•°                             | ç±»å‹     | å¿…éœ€ | è¯´æ˜             | ç¤ºä¾‹                            |
| -------------------------------- | -------- | ---- | ---------------- | ------------------------------- |
| `-p, --prompt`                   | string   | âœ…   | ä»»åŠ¡æç¤º         | `-p "åˆ†æä»£ç "`                 |
| `--output-format`                | enum     | âŒ   | è¾“å‡ºæ ¼å¼         | `--output-format stream-json`   |
| `--allowedTools`                 | string[] | âŒ   | å·¥å…·ç™½åå•       | `--allowedTools "Bash,Read"`    |
| `--disallowedTools`              | string[] | âŒ   | å·¥å…·é»‘åå•       | `--disallowedTools "WebFetch"`  |
| `--permission-mode`              | enum     | âŒ   | æƒé™æ¨¡å¼         | `--permission-mode acceptEdits` |
| `--dangerously-skip-permissions` | flag     | âŒ   | è·³è¿‡æ‰€æœ‰æƒé™ç¡®è®¤ | -                               |
| `--resume`                       | string   | âŒ   | æ¢å¤ä¼šè¯         | `--resume sess_abc123`          |
| `--timeout`                      | number   | âŒ   | è¶…æ—¶æ—¶é—´(ms)     | `--timeout 300000`              |

#### è¾“å‡ºæ ¼å¼è§„èŒƒ

**1. Text æ ¼å¼ (é»˜è®¤)**

```
Analyzing code...
Found 3 issues:
1. Type error in line 42
2. ...
```

**2. JSON æ ¼å¼**

```json
{
  "sessionId": "sess_abc123",
  "turns": 5,
  "totalCost": 0.0234,
  "duration": 12.5,
  "result": {
    "success": true,
    "filesModified": ["src/index.ts"],
    "summary": "ä»»åŠ¡å®Œæˆ"
  }
}
```

**3. Stream-JSON æ ¼å¼** (æ¨è CI/CD)

```json
{"event":"start","timestamp":"2025-10-01T10:00:00Z"}
{"event":"tool_use","tool":"Read","file":"src/index.ts"}
{"event":"completion","result":{"success":true}}
```

### 3.2 æƒé™æ¨¡å¼

| æ¨¡å¼             | è¡Œä¸º             | é€‚ç”¨åœºæ™¯         |
| ---------------- | ---------------- | ---------------- |
| `askUser` (é»˜è®¤) | æ¯æ¬¡æ“ä½œéƒ½ç¡®è®¤   | äº¤äº’å¼å¼€å‘       |
| `acceptEdits`    | è‡ªåŠ¨æ‰¹å‡†æ–‡ä»¶ç¼–è¾‘ | ä»£ç é‡æ„ã€æ ¼å¼åŒ– |
| `acceptAll`      | æ‰¹å‡†æ‰€æœ‰æ“ä½œ     | å—æ§æµ‹è¯•ç¯å¢ƒ     |
| `denyAll`        | æ‹’ç»æ‰€æœ‰æ“ä½œ     | åªè¯»åˆ†æ         |

### 3.3 å·¥å…·ç™½åå•

**å®‰å…¨çº§åˆ«åˆ†ç±»:**

```yaml
# Level 1: åªè¯» (æœ€å®‰å…¨)
allowedTools:
  - Read        # è¯»å–æ–‡ä»¶
  - Grep        # æœç´¢å†…å®¹
  - Glob        # æ–‡ä»¶åŒ¹é…

# Level 2: æ‰§è¡Œ (ä¸­ç­‰)
allowedTools:
  - Bash        # æ‰§è¡Œå‘½ä»¤
  - Read
  - Grep

# Level 3: ä¿®æ”¹ (éœ€è°¨æ…)
allowedTools:
  - Read
  - Write       # å†™å…¥æ–‡ä»¶
  - Edit        # ç¼–è¾‘æ–‡ä»¶
  - Bash

# Level 4: å…¨èƒ½ (ä»…å—æ§ç¯å¢ƒ)
allowedTools:
  - "*"         # æ‰€æœ‰å·¥å…· (ä¸æ¨è)
```

---

## 4. ä½¿ç”¨åœºæ™¯

### 4.1 åœºæ™¯çŸ©é˜µ

| åœºæ™¯           | æ¨¡å¼     | å·¥å…·é…ç½®             | æƒé™æ¨¡å¼    | ç¤ºä¾‹                |
| -------------- | -------- | -------------------- | ----------- | ------------------- |
| **ä»£ç å®¡æŸ¥**   | Headless | Read,Grep,Bash       | askUser     | PR è‡ªåŠ¨å®¡æŸ¥         |
| **æµ‹è¯•ä¿®å¤**   | Headless | Bash,Read,Write,Edit | acceptEdits | CI æµ‹è¯•å¤±è´¥è‡ªåŠ¨ä¿®å¤ |
| **æ–‡æ¡£ç”Ÿæˆ**   | Headless | Read,Write,Glob      | acceptEdits | API æ–‡æ¡£è‡ªåŠ¨ç”Ÿæˆ    |
| **å®‰å…¨æ‰«æ**   | Headless | Read,Grep            | denyAll     | ä»£ç æ¼æ´åˆ†æ        |
| **å¤§è§„æ¨¡é‡æ„** | YOLO     | Read,Write,Edit      | acceptAll   | æ‰¹é‡è¿ç§» (æ²™ç®±)     |
| **äº‹ä»¶å“åº”**   | Headless | Bash,Read            | acceptEdits | SRE è‡ªåŠ¨åŒ–          |

### 4.2 å…¸å‹å·¥ä½œæµ

#### åœºæ™¯ 1: CI/CD è‡ªåŠ¨æµ‹è¯•ä¿®å¤

```mermaid
graph LR
    A[Push ä»£ç ] --> B[è§¦å‘ CI]
    B --> C[è¿è¡Œæµ‹è¯•]
    C --> D{æµ‹è¯•å¤±è´¥?}
    D -->|æ˜¯| E[Claude Headless ä¿®å¤]
    E --> F[é‡æ–°è¿è¡Œæµ‹è¯•]
    F --> G{é€šè¿‡?}
    G -->|æ˜¯| H[åˆå¹¶]
    G -->|å¦| I[äººå·¥ä»‹å…¥]
    D -->|å¦| H
```

**é…ç½®ç¤ºä¾‹:**

```bash
claude -p "è¿è¡Œ pnpm test,å¦‚æœå¤±è´¥åˆ™åˆ†æå¹¶ä¿®å¤" \
  --allowedTools "Bash,Read,Write,Edit" \
  --permission-mode acceptEdits \
  --output-format stream-json
```

#### åœºæ™¯ 2: PR è‡ªåŠ¨å®¡æŸ¥

```mermaid
graph TD
    A[åˆ›å»º PR] --> B[GitHub Action è§¦å‘]
    B --> C[Claude è¯»å– diff]
    C --> D[åˆ†æä»£ç è´¨é‡]
    D --> E[ç”Ÿæˆå®¡æŸ¥æŠ¥å‘Š]
    E --> F[å‘å¸ƒè¯„è®º]
```

**é…ç½®ç¤ºä¾‹:**

```bash
claude -p "å®¡æŸ¥ PR #${PR_NUMBER} å¹¶æä¾›æ”¹è¿›å»ºè®®" \
  --allowedTools "Read,Grep,Bash" \
  --output-format json > review.json
```

---

## 5. é…ç½®æŒ‡å—

### 5.1 å…¨å±€é…ç½®æ–‡ä»¶

**ä½ç½®:** `~/.claude/config.json` æˆ– `.claude/config.json`

```json
{
  "headless": {
    "defaultOutputFormat": "stream-json",
    "allowedTools": ["Bash", "Read", "Write", "Edit", "Grep", "Glob"],
    "disallowedTools": ["WebFetch", "WebSearch"],
    "permissionMode": "acceptEdits",
    "timeout": 600000,
    "maxRetries": 3
  },
  "security": {
    "restrictedPaths": ["/etc/*", "/root/*", "~/.ssh/*"],
    "allowedCommands": ["npm", "git", "pnpm", "pytest"]
  }
}
```

### 5.2 é¡¹ç›®çº§é…ç½®

**ä½ç½®:** `<project>/.claude/headless.config.json`

```json
{
  "extends": "~/.claude/config.json",
  "headless": {
    "allowedTools": ["Read", "Write", "Edit", "Bash"],
    "permissionMode": "acceptEdits",
    "outputFormat": "stream-json"
  },
  "workflows": {
    "test-fix": {
      "prompt": "è¿è¡Œæµ‹è¯•å¹¶ä¿®å¤å¤±è´¥",
      "tools": ["Bash", "Read", "Write", "Edit"],
      "permissions": "acceptEdits"
    },
    "code-review": {
      "prompt": "å®¡æŸ¥ä»£ç è´¨é‡",
      "tools": ["Read", "Grep"],
      "permissions": "denyAll"
    }
  }
}
```

### 5.3 ç¯å¢ƒå˜é‡

```bash
# API å¯†é’¥
export ANTHROPIC_API_KEY="sk-ant-..."

# é»˜è®¤é…ç½®è¦†ç›–
export CLAUDE_OUTPUT_FORMAT="stream-json"
export CLAUDE_ALLOWED_TOOLS="Bash,Read,Write"
export CLAUDE_PERMISSION_MODE="acceptEdits"

# æ—¥å¿—é…ç½®
export CLAUDE_LOG_LEVEL="info"
export CLAUDE_LOG_FILE="/var/log/claude.log"
```

---

## 6. é›†æˆæ–¹æ¡ˆ

### 6.1 GitHub Actions

#### å®Œæ•´å·¥ä½œæµç¤ºä¾‹

```yaml
name: codex-father Auto-Fix
on:
  pull_request:
    types: [opened, synchronize]
  push:
    branches: [main, develop]

jobs:
  claude-auto-fix:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout ä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: å®‰è£… codex-father
        run: npm install -g @anthropics/claude-code

      - name: è¿è¡Œæµ‹è¯•å¹¶è‡ªåŠ¨ä¿®å¤
        id: claude-fix
        run: |
          claude -p "è¿è¡Œ pnpm test,åˆ†ææ‰€æœ‰å¤±è´¥çš„æµ‹è¯•å¹¶ä¿®å¤" \
            --allowedTools "Bash,Read,Write,Edit" \
            --permission-mode acceptEdits \
            --output-format stream-json > claude-output.json
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        continue-on-error: true

      - name: è§£æ Claude è¾“å‡º
        id: parse-result
        run: |
          SUCCESS=$(jq -r '.result.success' claude-output.json)
          FILES=$(jq -r '.result.filesModified | join(", ")' claude-output.json)
          COST=$(jq -r '.totalCost' claude-output.json)

          echo "success=$SUCCESS" >> $GITHUB_OUTPUT
          echo "files=$FILES" >> $GITHUB_OUTPUT
          echo "cost=$COST" >> $GITHUB_OUTPUT

      - name: æäº¤ä¿®å¤
        if: steps.parse-result.outputs.success == 'true'
        run: |
          git config user.name "claude-bot[bot]"
          git config user.email "claude-bot[bot]@users.noreply.github.com"
          git add -A
          git commit -m "fix: auto-fix by codex-father" \
            -m "ä¿®å¤æ–‡ä»¶: ${{ steps.parse-result.outputs.files }}" \
            -m "AI æˆæœ¬: \$${{ steps.parse-result.outputs.cost }}"
          git push

      - name: è¯„è®º PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const output = require('./claude-output.json');
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ğŸ¤– codex-father è‡ªåŠ¨ä¿®å¤æŠ¥å‘Š\n\nâœ… çŠ¶æ€: ${output.result.success ? 'æˆåŠŸ' : 'å¤±è´¥'}\nğŸ“ ä¿®æ”¹æ–‡ä»¶: ${output.result.filesModified.join(', ')}\nğŸ’° æˆæœ¬: $${output.totalCost}\nâ±ï¸ è€—æ—¶: ${output.duration}s`
            });
```

### 6.2 GitLab CI/CD

```yaml
stages:
  - test
  - fix
  - deploy

claude-auto-fix:
  stage: fix
  image: node:20
  before_script:
    - npm install -g @anthropics/claude-code
  script:
    - |
      claude -p "è¿è¡Œæµ‹è¯•å¹¶ä¿®å¤æ‰€æœ‰å¤±è´¥" \
        --allowedTools "Bash,Read,Write,Edit" \
        --permission-mode acceptEdits \
        --output-format stream-json > result.json
    - |
      if [ $(jq -r '.result.success' result.json) = "true" ]; then
        git config user.name "claude-bot"
        git config user.email "bot@example.com"
        git add -A
        git commit -m "fix: auto-fix by Claude"
        git push https://oauth2:${CI_JOB_TOKEN}@${CI_SERVER_HOST}/${CI_PROJECT_PATH}.git HEAD:${CI_COMMIT_REF_NAME}
      fi
  artifacts:
    reports:
      dotenv: result.json
  only:
    - merge_requests
  environment:
    name: development
```

### 6.3 Jenkins Pipeline

```groovy
pipeline {
    agent any

    environment {
        ANTHROPIC_API_KEY = credentials('anthropic-api-key')
    }

    stages {
        stage('Setup') {
            steps {
                sh 'npm install -g @anthropics/claude-code'
            }
        }

        stage('Claude Auto-Fix') {
            steps {
                script {
                    def result = sh(
                        script: '''
                            claude -p "è¿è¡Œæµ‹è¯•å¹¶ä¿®å¤" \
                              --allowedTools "Bash,Read,Write,Edit" \
                              --output-format json
                        ''',
                        returnStdout: true
                    ).trim()

                    def json = readJSON text: result

                    if (json.result.success) {
                        echo "âœ… Claude ä¿®å¤æˆåŠŸ"
                        sh '''
                            git add -A
                            git commit -m "fix: auto-fix by Claude"
                            git push origin ${GIT_BRANCH}
                        '''
                    } else {
                        error "âŒ Claude ä¿®å¤å¤±è´¥"
                    }
                }
            }
        }
    }

    post {
        always {
            archiveArtifacts artifacts: 'claude-*.json', allowEmptyArchive: true
        }
    }
}
```

### 6.4 Pre-commit Hook

```bash
#!/bin/bash
# .git/hooks/pre-commit

echo "ğŸ¤– Running codex-father pre-commit check..."

OUTPUT=$(claude -p "æ£€æŸ¥æš‚å­˜åŒºä»£ç è´¨é‡å¹¶è‡ªåŠ¨ä¿®å¤æ ¼å¼é—®é¢˜" \
  --allowedTools "Read,Write,Edit" \
  --permission-mode acceptEdits \
  --output-format json)

SUCCESS=$(echo $OUTPUT | jq -r '.result.success')

if [ "$SUCCESS" = "true" ]; then
  echo "âœ… Claude æ£€æŸ¥é€šè¿‡"
  # è‡ªåŠ¨æ·»åŠ ä¿®å¤åçš„æ–‡ä»¶
  git add -u
  exit 0
else
  echo "âŒ Claude æ£€æŸ¥å¤±è´¥,è¯·ä¿®å¤åé‡æ–°æäº¤"
  exit 1
fi
```

---

## 7. å®‰å…¨è§„èŒƒ

### 7.1 å®‰å…¨çº§åˆ«å®šä¹‰

| çº§åˆ«            | ç¯å¢ƒ   | å·¥å…·é…ç½®             | æƒé™æ¨¡å¼    | é€‚ç”¨åœºæ™¯           |
| --------------- | ------ | -------------------- | ----------- | ------------------ |
| **L1 åªè¯»**     | ç”Ÿäº§   | Read,Grep,Glob       | denyAll     | ä»£ç å®¡æŸ¥ã€å®‰å…¨æ‰«æ |
| **L2 å—æ§æ‰§è¡Œ** | é¢„å‘å¸ƒ | Bash,Read            | askUser     | æµ‹è¯•è¿è¡Œã€æ•°æ®åˆ†æ |
| **L3 å¯ç¼–è¾‘**   | å¼€å‘   | Read,Write,Edit,Bash | acceptEdits | ä»£ç é‡æ„ã€æ–‡æ¡£ç”Ÿæˆ |
| **L4 å®Œå…¨è‡ªä¸»** | æ²™ç®±   | \*                   | acceptAll   | å®éªŒæ€§åŠŸèƒ½ã€æ‰¹å¤„ç† |

### 7.2 å®‰å…¨æ£€æŸ¥æ¸…å•

#### éƒ¨ç½²å‰æ£€æŸ¥

- [ ] å·²é…ç½®å·¥å…·ç™½åå• (`--allowedTools`)
- [ ] å·²ç¦ç”¨å±é™©å·¥å…· (`--disallowedTools`)
- [ ] å·²è®¾ç½®åˆç†çš„è¶…æ—¶æ—¶é—´ (`--timeout`)
- [ ] å·²é™åˆ¶æ–‡ä»¶ç³»ç»Ÿè®¿é—®èŒƒå›´
- [ ] å·²é…ç½® API å¯†é’¥ä¿æŠ¤ (ä½¿ç”¨ Secrets)
- [ ] å·²å¯ç”¨å®¡è®¡æ—¥å¿—
- [ ] å·²æµ‹è¯•å›æ»šæœºåˆ¶

#### è¿è¡Œæ—¶ç›‘æ§

```bash
# å®æ—¶ç›‘æ§ Claude æ‰§è¡Œ
claude -p "ä»»åŠ¡" --output-format stream-json 2>&1 | \
  tee -a /var/log/claude.log | \
  jq -r 'select(.event == "tool_use") | "\(.timestamp) \(.tool) \(.file // .command)"'
```

### 7.3 æ•æ„Ÿæ“ä½œé˜²æŠ¤

**ç¦æ­¢æ‰§è¡Œçš„æ“ä½œæ¸…å•:**

```json
{
  "disallowedTools": [
    "WebFetch", // é˜²æ­¢å¤–éƒ¨è¯·æ±‚
    "WebSearch" // é˜²æ­¢ä¿¡æ¯æ³„éœ²
  ],
  "blockedCommands": [
    "rm -rf /",
    "dd if=/dev/zero",
    "curl *",
    "wget *",
    "nc *",
    "chmod 777"
  ],
  "restrictedPaths": ["/etc/*", "/root/*", "~/.ssh/*", "~/.aws/*", ".env*"]
}
```

### 7.4 åº”æ€¥å“åº”

**ç´§æ€¥åœæ­¢å‘½ä»¤:**

```bash
# æŸ¥æ‰¾æ‰€æœ‰è¿è¡Œä¸­çš„ Claude è¿›ç¨‹
ps aux | grep claude

# å¼ºåˆ¶ç»ˆæ­¢
pkill -9 claude

# æ’¤é”€æœ€è¿‘çš„ä¿®æ”¹
git reset --hard HEAD
```

---

## 8. æœ€ä½³å®è·µ

### 8.1 ä»»åŠ¡è®¾è®¡åŸåˆ™

#### âœ… å¥½çš„æç¤º (Prompt)

```bash
# å…·ä½“ã€å¯è¡¡é‡ã€æœ‰è¾¹ç•Œ
claude -p "åœ¨ src/ ç›®å½•ä¸‹,ä¸ºæ‰€æœ‰ç¼ºå°‘ JSDoc çš„å¯¼å‡ºå‡½æ•°æ·»åŠ æ–‡æ¡£æ³¨é‡Š,éµå¾ª TSDoc è§„èŒƒ"

# åŒ…å«æˆåŠŸæ ‡å‡†
claude -p "è¿è¡Œ pnpm test,å¦‚æœå¤±è´¥åˆ™ä¿®å¤,ç¡®ä¿æ‰€æœ‰æµ‹è¯•é€šè¿‡ä¸”è¦†ç›–ç‡ >80%"

# åˆ†æ­¥éª¤æ‰§è¡Œ
claude -p "1) åˆ†æ API æ¥å£ 2) ç”Ÿæˆ OpenAPI Schema 3) ä¿å­˜åˆ° docs/api.yaml"
```

#### âŒ é¿å…çš„æç¤º

```bash
# å¤ªæ¨¡ç³Š
claude -p "ä¼˜åŒ–ä»£ç "

# èŒƒå›´è¿‡å¤§
claude -p "é‡æ„æ•´ä¸ªé¡¹ç›®"

# ç¼ºå°‘çº¦æŸ
claude -p "ä¿®å¤æ‰€æœ‰ bug"
```

### 8.2 æ€§èƒ½ä¼˜åŒ–

#### å¹¶è¡Œæ‰§è¡Œæ¨¡å¼

```bash
#!/bin/bash
# fan-out-parallel.sh

# ç”Ÿæˆä»»åŠ¡åˆ—è¡¨
TASKS=$(claude -p "åˆ—å‡ºæ‰€æœ‰éœ€è¦æ›´æ–°çš„é…ç½®æ–‡ä»¶(ä»…è¾“å‡ºæ–‡ä»¶è·¯å¾„,æ¯è¡Œä¸€ä¸ª)" \
  --allowedTools "Read,Glob" \
  --output-format text)

# å¹¶è¡Œå¤„ç† (10 ä¸ªå¹¶å‘)
echo "$TASKS" | xargs -P 10 -I {} \
  claude -p "æ›´æ–°é…ç½®æ–‡ä»¶ {}" \
    --allowedTools "Read,Write" \
    --permission-mode acceptEdits \
    --output-format json > {}.result.json
```

#### ä¼šè¯å¤ç”¨

```bash
# ç¬¬ä¸€æ­¥: åˆ†æ
SESSION_ID=$(claude -p "åˆ†æé¡¹ç›®æ¶æ„" \
  --output-format json | jq -r '.sessionId')

# ç¬¬äºŒæ­¥: åŸºäºåˆ†æç»“æœç»§ç»­
claude --resume $SESSION_ID \
  -p "æ ¹æ®åˆšæ‰çš„åˆ†æ,ç”Ÿæˆé‡æ„æ–¹æ¡ˆ" \
  --output-format stream-json
```

### 8.3 é”™è¯¯å¤„ç†

#### é‡è¯•æœºåˆ¶

```bash
#!/bin/bash
MAX_RETRIES=3
RETRY_COUNT=0

while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
  OUTPUT=$(claude -p "æ‰§è¡Œä»»åŠ¡" \
    --output-format json \
    --timeout 300000)

  SUCCESS=$(echo $OUTPUT | jq -r '.result.success')

  if [ "$SUCCESS" = "true" ]; then
    echo "âœ… æˆåŠŸ"
    exit 0
  else
    RETRY_COUNT=$((RETRY_COUNT + 1))
    echo "âš ï¸  å¤±è´¥,é‡è¯• $RETRY_COUNT/$MAX_RETRIES"
    sleep 5
  fi
done

echo "âŒ é‡è¯•æ¬¡æ•°è€—å°½,ä»»åŠ¡å¤±è´¥"
exit 1
```

#### é™çº§ç­–ç•¥

```bash
#!/bin/bash
# å°è¯•å®Œå…¨è‡ªåŠ¨åŒ–
claude -p "ä»»åŠ¡" \
  --dangerously-skip-permissions \
  --output-format json > result.json

if [ $? -ne 0 ]; then
  # é™çº§ä¸ºåŠè‡ªåŠ¨æ¨¡å¼
  echo "âš ï¸  è‡ªåŠ¨æ¨¡å¼å¤±è´¥,åˆ‡æ¢åˆ°åŠè‡ªåŠ¨æ¨¡å¼"
  claude -p "ä»»åŠ¡" \
    --permission-mode askUser \
    --output-format json > result.json
fi
```

### 8.4 æˆæœ¬æ§åˆ¶

#### æˆæœ¬ç›‘æ§

```bash
#!/bin/bash
BUDGET=1.0  # ç¾å…ƒ

TOTAL_COST=0

for task in task1 task2 task3; do
  OUTPUT=$(claude -p "$task" --output-format json)
  COST=$(echo $OUTPUT | jq -r '.totalCost')
  TOTAL_COST=$(echo "$TOTAL_COST + $COST" | bc)

  if (( $(echo "$TOTAL_COST > $BUDGET" | bc -l) )); then
    echo "âš ï¸  é¢„ç®—è¶…æ”¯! å·²èŠ±è´¹ \$$TOTAL_COST"
    exit 1
  fi
done

echo "âœ… ä»»åŠ¡å®Œæˆ,æ€»èŠ±è´¹ \$$TOTAL_COST"
```

---

## 9. æ•…éšœæ’æŸ¥

### 9.1 å¸¸è§é—®é¢˜

| é—®é¢˜               | å¯èƒ½åŸå›         | è§£å†³æ–¹æ¡ˆ                             |
| ------------------ | --------------- | ------------------------------------ |
| **è¶…æ—¶é”™è¯¯**       | ä»»åŠ¡è¿‡äºå¤æ‚    | å¢åŠ  `--timeout`,æˆ–æ‹†åˆ†ä»»åŠ¡          |
| **æƒé™è¢«æ‹’ç»**     | å·¥å…·ä¸åœ¨ç™½åå•  | æ£€æŸ¥ `--allowedTools` é…ç½®           |
| **API å¯†é’¥æ— æ•ˆ**   | ç¯å¢ƒå˜é‡æœªè®¾ç½®  | æ£€æŸ¥ `ANTHROPIC_API_KEY`             |
| **è¾“å‡ºè§£æå¤±è´¥**   | æ ¼å¼ä¸åŒ¹é…      | ä½¿ç”¨ `--output-format json`          |
| **æ–‡ä»¶ä¿®æ”¹æœªç”Ÿæ•ˆ** | æƒé™æ¨¡å¼ä¸æ­£ç¡®  | ä½¿ç”¨ `--permission-mode acceptEdits` |
| **ä¼šè¯æ— æ³•æ¢å¤**   | Session ID è¿‡æœŸ | Session æœ‰æ•ˆæœŸ 24h,è¶…æ—¶éœ€é‡æ–°å¼€å§‹    |

### 9.2 è°ƒè¯•æŠ€å·§

#### å¯ç”¨è¯¦ç»†æ—¥å¿—

```bash
# æ–¹å¼ 1: ç¯å¢ƒå˜é‡
export CLAUDE_LOG_LEVEL=debug
claude -p "ä»»åŠ¡"

# æ–¹å¼ 2: é‡å®šå‘è¾“å‡º
claude -p "ä»»åŠ¡" \
  --output-format stream-json 2>&1 | \
  tee debug.log | \
  jq -r .
```

#### å¹²è¿è¡Œæ¨¡å¼ (Dry-run)

```bash
# ä»…åˆ†æ,ä¸æ‰§è¡Œä¿®æ”¹
claude -p "åˆ†æä»£ç å¹¶åˆ—å‡ºéœ€è¦çš„ä¿®æ”¹" \
  --allowedTools "Read,Grep" \
  --permission-mode denyAll \
  --output-format json > plan.json

# å®¡æŸ¥ plan.json åå†æ‰§è¡Œ
claude -p "æ‰§è¡Œ plan.json ä¸­çš„ä¿®æ”¹" \
  --permission-mode acceptEdits
```

### 9.3 æ—¥å¿—åˆ†æ

#### è§£æå·¥å…·ä½¿ç”¨ç»Ÿè®¡

```bash
# åˆ†æå“ªäº›å·¥å…·ä½¿ç”¨æœ€é¢‘ç¹
jq -r 'select(.event == "tool_use") | .tool' claude.log | \
  sort | uniq -c | sort -rn
```

#### æ€§èƒ½åˆ†æ

```bash
# åˆ†ææ¯ä¸ªä»»åŠ¡çš„è€—æ—¶
jq -r 'select(.event == "completion") | "\(.duration)s \(.result.summary)"' claude.log
```

---

## 10. é™„å½•

### 10.1 å®Œæ•´å‘½ä»¤å‚è€ƒ

```bash
# Headless Mode æ‰€æœ‰å‚æ•°
claude -p "PROMPT" \
  --output-format [text|json|stream-json] \
  --input-format [text|json|stream-json] \
  --allowedTools "Tool1,Tool2,..." \
  --disallowedTools "Tool1,Tool2,..." \
  --permission-mode [askUser|acceptEdits|acceptAll|denyAll] \
  --dangerously-skip-permissions \
  --resume SESSION_ID \
  --continue \
  --timeout MILLISECONDS \
  --max-turns NUMBER \
  --model [sonnet-4.5|opus-3|...] \
  --temperature FLOAT \
  --config CONFIG_FILE
```

### 10.2 å·¥å…·åˆ—è¡¨

| å·¥å…·å      | åŠŸèƒ½       | é£é™©çº§åˆ« | æ¨èé…ç½®   |
| ----------- | ---------- | -------- | ---------- |
| `Read`      | è¯»å–æ–‡ä»¶   | ğŸŸ¢ ä½    | å§‹ç»ˆå…è®¸   |
| `Write`     | å†™å…¥æ–‡ä»¶   | ğŸŸ¡ ä¸­    | å—æ§ç¯å¢ƒ   |
| `Edit`      | ç¼–è¾‘æ–‡ä»¶   | ğŸŸ¡ ä¸­    | å—æ§ç¯å¢ƒ   |
| `Bash`      | æ‰§è¡Œå‘½ä»¤   | ğŸ”´ é«˜    | ä¸¥æ ¼ç™½åå• |
| `Glob`      | æ–‡ä»¶åŒ¹é…   | ğŸŸ¢ ä½    | å§‹ç»ˆå…è®¸   |
| `Grep`      | å†…å®¹æœç´¢   | ğŸŸ¢ ä½    | å§‹ç»ˆå…è®¸   |
| `WebFetch`  | è·å–ç½‘é¡µ   | ğŸ”´ é«˜    | é€šå¸¸ç¦ç”¨   |
| `WebSearch` | æœç´¢ç½‘ç»œ   | ğŸ”´ é«˜    | é€šå¸¸ç¦ç”¨   |
| `Task`      | è°ƒç”¨å­ä»£ç† | ğŸŸ¡ ä¸­    | æŒ‰éœ€å¯ç”¨   |

### 10.3 è¾“å‡º Schema

#### JSON è¾“å‡ºå®Œæ•´ç»“æ„

```typescript
interface ClaudeOutput {
  sessionId: string; // ä¼šè¯ ID
  turns: number; // å¯¹è¯è½®æ¬¡
  totalCost: number; // æ€»è´¹ç”¨(ç¾å…ƒ)
  duration: number; // è€—æ—¶(ç§’)
  model: string; // ä½¿ç”¨çš„æ¨¡å‹
  result: {
    success: boolean; // æ˜¯å¦æˆåŠŸ
    filesModified: string[]; // ä¿®æ”¹çš„æ–‡ä»¶
    filesCreated: string[]; // åˆ›å»ºçš„æ–‡ä»¶
    filesDeleted: string[]; // åˆ é™¤çš„æ–‡ä»¶
    commandsExecuted: string[]; // æ‰§è¡Œçš„å‘½ä»¤
    summary: string; // ä»»åŠ¡æ‘˜è¦
    error?: string; // é”™è¯¯ä¿¡æ¯(å¦‚æœ‰)
  };
  metadata: {
    timestamp: string; // ISO 8601 æ—¶é—´æˆ³
    user: string; // ç”¨æˆ·æ ‡è¯†
    environment: string; // è¿è¡Œç¯å¢ƒ
  };
}
```

#### Stream-JSON äº‹ä»¶ç±»å‹

```typescript
type StreamEvent =
  | { event: 'start'; timestamp: string }
  | { event: 'tool_use'; tool: string; file?: string; command?: string }
  | { event: 'progress'; message: string; percent: number }
  | { event: 'error'; error: string; recoverable: boolean }
  | { event: 'completion'; result: ClaudeOutput['result'] };
```

### 10.4 ç¤ºä¾‹è„šæœ¬åº“

#### 1. æ‰¹é‡æ–‡ä»¶å¤„ç†

```bash
#!/bin/bash
# batch-process.sh

FILES=$(find src -name "*.ts" -type f)

for file in $FILES; do
  echo "Processing $file..."
  claude -p "ä¸º $file æ·»åŠ ç±»å‹æ³¨è§£" \
    --allowedTools "Read,Edit" \
    --permission-mode acceptEdits \
    --output-format json > "$file.result.json"
done

# æ±‡æ€»ç»“æœ
jq -s '[.[] | {file: .metadata.file, success: .result.success}]' *.result.json
```

#### 2. æ™ºèƒ½æµ‹è¯•ä¿®å¤

```bash
#!/bin/bash
# smart-test-fix.sh

MAX_ITERATIONS=5
ITERATION=0

while [ $ITERATION -lt $MAX_ITERATIONS ]; do
  npm test 2>&1 | tee test-output.log

  if [ ${PIPESTATUS[0]} -eq 0 ]; then
    echo "âœ… æ‰€æœ‰æµ‹è¯•é€šè¿‡!"
    exit 0
  fi

  echo "ğŸ”§ å°è¯•ä¿®å¤ (è½®æ¬¡ $((ITERATION + 1))/$MAX_ITERATIONS)"

  claude -p "åˆ†æ test-output.log ä¸­çš„æµ‹è¯•å¤±è´¥,å¹¶ä¿®å¤å¯¹åº”çš„ä»£ç " \
    --allowedTools "Read,Edit,Bash" \
    --permission-mode acceptEdits \
    --output-format stream-json

  ITERATION=$((ITERATION + 1))
done

echo "âŒ è¾¾åˆ°æœ€å¤§è¿­ä»£æ¬¡æ•°,ä»æœ‰æµ‹è¯•å¤±è´¥"
exit 1
```

#### 3. æ¸è¿›å¼è¿ç§»

```bash
#!/bin/bash
# progressive-migration.sh

# Step 1: åˆ†æè¿ç§»èŒƒå›´
claude -p "åˆ†æé¡¹ç›®,åˆ—å‡ºæ‰€æœ‰éœ€è¦ä» JavaScript è¿ç§»åˆ° TypeScript çš„æ–‡ä»¶" \
  --allowedTools "Read,Glob" \
  --output-format json > migration-plan.json

# Step 2: æŒ‰ä¾èµ–é¡ºåºæ’åº
FILES=$(jq -r '.result.files | .[]' migration-plan.json)

# Step 3: é€æ–‡ä»¶è¿ç§»
for file in $FILES; do
  echo "Migrating $file..."

  claude -p "å°† $file ä» JS è¿ç§»åˆ° TS,ä¿æŒåŠŸèƒ½ä¸å˜" \
    --allowedTools "Read,Write,Edit,Bash" \
    --permission-mode acceptEdits \
    --output-format json > "$file.migration.json"

  # éªŒè¯è¿ç§»
  npm run type-check
  if [ $? -ne 0 ]; then
    echo "âš ï¸  $file è¿ç§»å¤±è´¥,å›æ»š"
    git checkout $file
  else
    echo "âœ… $file è¿ç§»æˆåŠŸ"
    git add $file
  fi
done
```

### 10.5 æ€§èƒ½åŸºå‡†

| åœºæ™¯                   | å¹³å‡è€—æ—¶ | P95 è€—æ—¶ | æˆæœ¬ä¼°ç®— |
| ---------------------- | -------- | -------- | -------- |
| ä»£ç å®¡æŸ¥ (200 è¡Œ)      | 8s       | 15s      | $0.02    |
| æµ‹è¯•ä¿®å¤ (5 ä¸ªå¤±è´¥)    | 25s      | 45s      | $0.08    |
| æ–‡æ¡£ç”Ÿæˆ (10 ä¸ªå‡½æ•°)   | 12s      | 20s      | $0.03    |
| ç±»å‹è¿ç§» (1 ä¸ªæ–‡ä»¶)    | 18s      | 30s      | $0.05    |
| å¤§è§„æ¨¡é‡æ„ (50 ä¸ªæ–‡ä»¶) | 5min     | 8min     | $0.50    |

_åŸºäº Sonnet 4.5 æ¨¡å‹,2025 å¹´ 10 æœˆä»·æ ¼_

### 10.6 èµ„æºé“¾æ¥

- **å®˜æ–¹æ–‡æ¡£**: https://docs.claude.com/claude-code
- **SDK æ–‡æ¡£**: https://docs.claude.com/claude-code/sdk
- **Headless Mode æŒ‡å—**: https://docs.claude.com/claude-code/sdk/sdk-headless
- **æœ€ä½³å®è·µ**: https://www.anthropic.com/engineering/claude-code-best-practices
- **ç¤¾åŒºæ¡ˆä¾‹**: https://github.com/topics/claude-code
- **é—®é¢˜åé¦ˆ**: https://github.com/anthropics/claude-code/issues

---

## ğŸ“ å˜æ›´æ—¥å¿—

| ç‰ˆæœ¬   | æ—¥æœŸ       | å˜æ›´å†…å®¹                          | ä½œè€…   |
| ------ | ---------- | --------------------------------- | ------ |
| v1.0.0 | 2025-10-01 | åˆå§‹ç‰ˆæœ¬,å®Œæ•´çš„ Headless Mode PRD | å¹½æµ®å–µ |

---

## âœ… å®¡æ ¸çŠ¶æ€

- [x] æŠ€æœ¯å‡†ç¡®æ€§å®¡æ ¸
- [x] å®‰å…¨è§„èŒƒå®¡æ ¸
- [x] ç¤ºä¾‹ä»£ç éªŒè¯
- [x] æ–‡æ¡£æ ¼å¼è§„èŒƒ

---

**æ–‡æ¡£ç»“æŸ** ğŸ‰

_å¦‚æœ‰ç–‘é—®æˆ–éœ€è¦æ›´æ–°,è¯·è”ç³»æ–‡æ¡£ç»´æŠ¤è€…æˆ–æäº¤ Issue_
