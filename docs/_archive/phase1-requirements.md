# Phase 1: 核心功能增强 - 需求文档

## 1. 文档概述

### 1.1 项目背景

Codex Father 项目需要支持与 Claude
Code 的完整集成，实现从任务接收到代码开发、分支管理、PR创建的全自动化工作流。

### 1.2 阶段目标

Phase
1 专注于构建核心的 Git 工作流管理能力和任务队列系统，为后续的测试和集成奠定基础。

### 1.3 范围说明

- **包含**: Git 分支管理、任务状态追踪、MCP 工具扩展、非交互模式优化
- **不包含**: 完整的测试体系、容器环境优化、CI/CD 集成

## 2. 功能需求

### 2.1 Git 工作流管理模块

#### 2.1.1 分支管理

**需求ID**: REQ-P1-001 **优先级**: 高
**描述**: 实现自动化的 Git 分支创建、切换和管理功能

**功能要求**:

- 根据任务ID自动创建功能分支，命名格式: `feature/codex-task-{task_id}`
- 支持从指定基础分支创建功能分支 (默认: main/master)
- 提供分支清理和删除功能
- 检测并处理分支冲突情况
- 支持分支状态查询和列表展示

**验收标准**:

- [ ] 能够自动创建符合命名规范的功能分支
- [ ] 支持指定基础分支创建功能分支
- [ ] 能够检测现有分支并避免重复创建
- [ ] 提供分支清理机制，删除已合并的功能分支
- [ ] 所有 Git 操作都有错误处理和回滚机制

#### 2.1.2 代码提交管理

**需求ID**: REQ-P1-002 **优先级**: 高 **描述**: 自动化代码提交和推送流程

**功能要求**:

- 智能检测代码变更并自动提交
- 生成标准化的提交信息格式
- 支持分阶段提交 (staged commits)
- 自动推送到远程仓库
- 提供提交历史追踪

**验收标准**:

- [ ] 能够检测工作区的代码变更
- [ ] 自动生成符合规范的提交信息
- [ ] 支持增量提交和全量提交
- [ ] 成功推送到远程仓库并处理推送失败
- [ ] 维护完整的提交历史记录

#### 2.1.3 PR 自动创建

**需求ID**: REQ-P1-003 **优先级**: 高 **描述**: 集成 GitHub CLI 实现自动 PR 创建

**功能要求**:

- 使用 GitHub CLI (gh) 创建 Pull Request
- 自动生成 PR 标题和描述
- 支持自定义 PR 模板
- 设置合适的 reviewers 和 labels
- 链接相关的 issues

**验收标准**:

- [ ] 能够调用 gh CLI 创建 PR
- [ ] 自动生成包含任务信息的 PR 描述
- [ ] 支持配置默认的 reviewers
- [ ] 能够设置相关的 labels 和 milestones
- [ ] 处理 PR 创建失败的情况

### 2.2 任务状态追踪系统

#### 2.2.1 任务生命周期管理

**需求ID**: REQ-P1-004 **优先级**: 高
**描述**: 实现完整的任务状态跟踪和生命周期管理

**功能要求**:

- 定义任务状态枚举: `created`, `in_progress`, `completed`, `failed`, `cancelled`
- 维护任务状态转换规则和历史
- 提供任务状态查询接口
- 支持任务状态变更通知
- 实现任务超时和异常处理

**验收标准**:

- [ ] 定义完整的任务状态模型
- [ ] 实现状态转换的验证和记录
- [ ] 提供 RESTful 或 MCP 接口查询状态
- [ ] 支持状态变更的事件通知
- [ ] 处理任务超时和异常状态

#### 2.2.2 任务队列管理

**需求ID**: REQ-P1-005 **优先级**: 中 **描述**: 管理并发任务和队列调度

**功能要求**:

- 维护全局任务队列
- 支持任务优先级设置
- 实现并发控制和资源管理
- 提供队列状态监控
- 支持任务取消和重试

**验收标准**:

- [ ] 实现基于优先级的任务队列
- [ ] 支持配置最大并发任务数
- [ ] 提供队列长度和状态查询
- [ ] 能够取消排队中的任务
- [ ] 支持失败任务的自动重试

#### 2.2.3 持久化存储

**需求ID**: REQ-P1-006 **优先级**: 中 **描述**: 任务状态和元数据的持久化存储

**功能要求**:

- 使用 JSON 文件存储任务元数据
- 实现任务状态的原子性更新
- 提供数据备份和恢复机制
- 支持历史数据清理
- 实现数据完整性检查

**验收标准**:

- [ ] 所有任务数据持久化到文件系统
- [ ] 状态更新操作具有原子性
- [ ] 提供数据备份和恢复功能
- [ ] 支持配置数据保留策略
- [ ] 实现数据完整性校验

### 2.3 MCP 服务器工具扩展

#### 2.3.1 Git 操作工具

**需求ID**: REQ-P1-007 **优先级**: 高 **描述**: 在 MCP 服务器中暴露 Git 操作能力

**功能要求**:

- 新增 `codex.git.branch` 工具 - 分支管理
- 新增 `codex.git.commit` 工具 - 代码提交
- 新增 `codex.git.push` 工具 - 推送代码
- 新增 `codex.git.pr` 工具 - 创建 PR
- 所有工具支持参数验证和错误处理

**验收标准**:

- [ ] 实现所有 Git 相关的 MCP 工具
- [ ] 工具参数符合 JSON Schema 规范
- [ ] 提供详细的错误信息和状态码
- [ ] 支持异步操作和状态查询
- [ ] 所有工具都有完整的文档

#### 2.3.2 任务管理工具

**需求ID**: REQ-P1-008 **优先级**: 高 **描述**: 扩展现有任务管理工具功能

**功能要求**:

- 扩展 `codex.start` 支持 Git 工作流参数
- 新增 `codex.task.create` 工具 - 创建带 Git 工作流的任务
- 新增 `codex.task.status` 工具 - 增强状态查询
- 新增 `codex.queue.monitor` 工具 - 队列监控
- 集成任务与 Git 分支的关联

**验收标准**:

- [ ] 现有工具向后兼容并增强功能
- [ ] 新工具完整集成 Git 工作流
- [ ] 支持任务与分支的双向关联查询
- [ ] 提供队列状态的实时监控
- [ ] 所有工具响应时间 < 500ms

#### 2.3.3 状态查询接口

**需求ID**: REQ-P1-009 **优先级**: 中 **描述**: 提供丰富的状态查询和监控接口

**功能要求**:

- 新增 `codex.status.detailed` 工具 - 详细状态信息
- 新增 `codex.monitor.health` 工具 - 健康检查
- 支持状态变更的 WebHook 通知
- 提供性能指标和统计信息
- 实现状态缓存和优化查询

**验收标准**:

- [ ] 提供多层次的状态查询接口
- [ ] 支持实时状态推送和通知
- [ ] 查询响应包含完整的上下文信息
- [ ] 实现查询结果缓存提升性能
- [ ] 支持状态历史查询和分析

### 2.4 非交互模式配置优化

#### 2.4.1 环境自适应配置

**需求ID**: REQ-P1-010 **优先级**: 中 **描述**: 自动检测运行环境并应用合适的配置

**功能要求**:

- 检测 CI/CD 环境 (GitHub Actions, GitLab CI, etc.)
- 检测容器环境 (Docker, DevContainer)
- 自动选择合适的沙盒模式
- 设置环境特定的默认参数
- 提供配置覆盖机制

**验收标准**:

- [ ] 能够识别主流 CI/CD 环境
- [ ] 自动检测容器运行状态
- [ ] 根据环境自动选择沙盒策略
- [ ] 支持用户配置覆盖自动检测
- [ ] 提供环境配置的诊断工具

#### 2.4.2 预设模式扩展

**需求ID**: REQ-P1-011 **优先级**: 低
**描述**: 扩展现有预设模式以支持 Git 工作流

**功能要求**:

- 新增 `--preset ci-auto` - CI 环境全自动模式
- 新增 `--preset dev-workflow` - 开发工作流模式
- 扩展现有预设支持 Git 参数
- 提供预设参数的可视化和验证
- 支持自定义预设配置

**验收标准**:

- [ ] 新预设模式正确配置所有相关参数
- [ ] 预设参数经过验证且互不冲突
- [ ] 支持预设的组合和继承
- [ ] 提供预设使用的帮助和示例
- [ ] 用户可以保存自定义预设

## 3. 非功能需求

### 3.1 基本响应时间需求

- Git 操作响应时间 < 10秒 (本地环境)
- 任务状态查询响应时间 < 1秒
- 支持并发处理至少 5 个任务
- 适合本地开发环境的资源使用

### 3.2 可靠性需求

- Git 操作失败后能够自动回滚
- 任务状态数据不丢失
- 系统异常重启后能恢复任务状态
- 网络中断后支持操作重试

### 3.3 安全需求

- 所有 Git 操作在指定仓库范围内
- 敏感信息 (如访问令牌) 安全存储
- 支持沙盒模式限制操作权限
- 审计日志记录所有关键操作

### 3.4 兼容性需求

- 支持 Git 版本 >= 2.25
- 兼容 GitHub CLI >= 2.0
- 支持 Node.js >= 18
- 兼容 Linux/macOS/WSL 环境

## 4. 接口需求

### 4.1 MCP 工具接口

```typescript
// Git 操作工具
interface GitBranchTool {
  name: 'codex.git.branch';
  arguments: {
    action: 'create' | 'delete' | 'list';
    branchName?: string;
    baseBranch?: string;
    taskId?: string;
  };
}

// 任务创建工具
interface TaskCreateTool {
  name: 'codex.task.create';
  arguments: {
    description: string;
    enableGitWorkflow?: boolean;
    baseBranch?: string;
    autoCreatePR?: boolean;
    args?: string[];
  };
}
```

### 4.2 状态数据结构

```json
{
  "taskId": "task-12345",
  "status": "in_progress",
  "description": "实现用户认证功能",
  "createdAt": "2025-09-26T10:30:00Z",
  "updatedAt": "2025-09-26T11:45:00Z",
  "gitWorkflow": {
    "enabled": true,
    "branchName": "feature/codex-task-12345",
    "baseBranch": "main",
    "prUrl": null,
    "commits": []
  },
  "execution": {
    "sessionDir": ".codex-father/sessions/task-12345",
    "logFile": "job.log",
    "exitCode": null
  }
}
```

## 5. 约束条件

### 5.1 技术约束

- 必须保持现有 CLI 接口的向后兼容性
- Git 操作必须使用原生 Git 命令
- 所有新功能必须支持非交互模式
- 状态存储使用 JSON 文件格式

### 5.2 业务约束

- 任务执行超时时间最长 2 小时
- 单个仓库最多同时处理 20 个任务
- Git 分支命名必须遵循项目规范
- PR 创建需要有效的 GitHub 权限

### 5.3 时间约束

- Phase 1 开发周期: 1-2 周
- 核心功能优先开发
- 必须为 Phase 2 测试预留接口

## 6. 验收标准

### 6.1 功能验收

- [ ] 所有 MCP 工具正常工作并通过集成测试
- [ ] Git 工作流完整流程测试通过
- [ ] 任务状态管理功能完整且数据一致
- [ ] 非交互模式在各种环境下正常工作

### 6.2 质量验收

- [ ] 代码覆盖率 >= 80%
- [ ] 所有 ESLint 和 ShellCheck 检查通过
- [ ] 基本功能响应时间满足要求
- [ ] 安全扫描无高危漏洞

### 6.3 文档验收

- [ ] API 文档完整且示例正确
- [ ] 用户使用指南更新
- [ ] 故障排查文档完善
- [ ] 配置说明文档更新

---

**文档版本**: v1.0 **创建日期**: 2025-09-26 **负责人**: Claude Code 集成项目组
**审批状态**: 待审批
